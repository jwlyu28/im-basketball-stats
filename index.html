<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IM Supervisor Console (Live)</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a27; --muted:#8aa0b8; --text:#e9f0f7;
      --line:#243246; --accent:#4da3ff; --good:#37d67a; --bad:#ff5c5c; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:10;
      padding:12px 14px;border-bottom:1px solid var(--line);
      background:rgba(11,15,23,.92);backdrop-filter: blur(8px);
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap
    }
    header h1{margin:0;font-size:15px;letter-spacing:.2px}
    header .sub{color:var(--muted);font-size:12px;min-height:14px}
    main{padding:14px;max-width:1250px;margin:0 auto;display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .split{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width: 980px){ .split{grid-template-columns:1fr} }
    label{font-size:12px;color:var(--muted)}
    input, select, textarea, button{
      background:#0e1522;border:1px solid var(--line);color:var(--text);
      padding:10px 10px;border-radius:12px;font-size:14px
    }
    textarea{width:100%;min-height:92px;resize:vertical}
    input, select{width:100%}
    button{cursor:pointer;user-select:none}
    button.primary{border-color:transparent;background:var(--accent);color:#06101c;font-weight:900}
    button.good{border-color:transparent;background:var(--good);color:#06101c;font-weight:900}
    button.bad{border-color:transparent;background:var(--bad);color:#2b0505;font-weight:900}
    button.warn{border-color:transparent;background:var(--warn);color:#2b2205;font-weight:900}
    button.ghost{background:transparent}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);padding:8px 10px;border-radius:999px}
    .tiny{font-size:12px;color:var(--muted)}
    .dangerLine{border-top:1px dashed var(--line);margin:10px 0}
    .gridCourts{display:grid;gap:12px;grid-template-columns:repeat(3, minmax(0, 1fr))}
    @media (max-width: 980px){ .gridCourts{grid-template-columns:repeat(2, minmax(0, 1fr))} }
    @media (max-width: 560px){ .gridCourts{grid-template-columns:1fr} }

    .courtCard{padding:12px;border-radius:16px;border:1px solid var(--line);background:#0e1522}
    .courtTop{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .courtNum{font-weight:900}
    .statusLive{color:#bff2d2}
    .statusIdle{color:var(--muted)}

    .bigNum{font-size:44px;font-weight:1000;letter-spacing:1px;line-height:1}
    .bigLabel{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
    .teamName{font-size:16px;font-weight:900}
    .teamPanel{border:1px solid var(--line);border-radius:16px;padding:12px;background:#0e1522}
    .btnGrid3{display:grid;gap:10px;grid-template-columns:repeat(3, minmax(0,1fr))}
    .btnGrid2{display:grid;gap:10px;grid-template-columns:repeat(2, minmax(0,1fr))}
    .btnGrid4{display:grid;gap:10px;grid-template-columns:repeat(4, minmax(0,1fr))}
    @media (max-width: 560px){ .btnGrid4{grid-template-columns:repeat(2, minmax(0,1fr))} }

    .log{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:12px}
    .logItem{display:flex;justify-content:space-between;gap:10px;padding:10px;border-bottom:1px solid var(--line)}
    .logItem:last-child{border-bottom:none}
    .tag{font-size:12px;border:1px solid var(--line);padding:4px 8px;border-radius:999px;color:var(--muted)}
    .tag.good{background:rgba(55,214,122,.14);border-color:rgba(55,214,122,.35);color:#bff2d2}
    .tag.warn{background:rgba(255,209,102,.12);border-color:rgba(255,209,102,.35);color:#ffefc4}
    .tag.bad{background:rgba(255,92,92,.12);border-color:rgba(255,92,92,.35);color:#ffd0d0}

    table{width:100%;border-collapse:collapse}
    th, td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:800}
    td:last-child, th:last-child{text-align:right}
  </style>
</head>
<body>
<header>
  <div>
    <h1 id="hdrTitle">IM Supervisor Console</h1>
    <div class="sub" id="hdrSub"></div>
  </div>
  <div class="row">
    <div class="pill"><span>Connection</span> <b id="connLabel">…</b></div>
    <button class="ghost" id="navLobbyBtn" style="display:none">← Lobby</button>
  </div>
</header>

<main>
  <!-- LOBBY -->
  <section id="viewLobby" class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div style="font-weight:900">Games Lobby</div>
        <div class="tiny">Create a game on a court, or tap an ongoing game to open its console.</div>
      </div>
      <div class="row">
        <button class="ghost" id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div class="dangerLine"></div>

    <div class="split">
      <div class="card">
        <div style="font-weight:900;margin-bottom:8px">Create / Start Game</div>
        <div class="split">
          <div>
            <label>Court (1–6)</label>
            <select id="courtSelect">
              <option value="1">Court 1</option>
              <option value="2">Court 2</option>
              <option value="3">Court 3</option>
              <option value="4">Court 4</option>
              <option value="5">Court 5</option>
              <option value="6">Court 6</option>
            </select>
          </div>
          <div>
            <label>Start quarter</label>
            <select id="startQuarter">
              <option value="1">Q1</option>
              <option value="2">Q2</option>
              <option value="3">Q3</option>
              <option value="4">Q4</option>
            </select>
          </div>
        </div>
        <div class="split" style="margin-top:10px">
          <div>
            <label>Team A</label>
            <input id="newTeamA" placeholder="Team A name"/>
          </div>
          <div>
            <label>Team B</label>
            <input id="newTeamB" placeholder="Team B name"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px;justify-content:flex-end">
          <button class="primary" id="createGameBtn">Create game</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900;margin-bottom:8px">Ongoing Games</div>
        <div id="ongoingList" class="tiny">Loading…</div>
      </div>
    </div>

    <div class="dangerLine"></div>

    <div class="gridCourts" id="courtsGrid"></div>
  </section>

  <!-- GAME -->
  <section id="viewGame" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="pill"><span>Court</span> <b id="gameCourt">-</b></div>
        <div class="pill"><span>Game</span> <b id="gameId">-</b></div>
        <div class="pill"><span>Quarter</span> <b id="gameQuarter">Q1</b></div>
      </div>
      <div class="row">
        <button class="ghost" id="endGameBtn">End game</button>
        <button class="bad" id="undoBtn">Undo</button>
      </div>
    </div>

    <div class="dangerLine"></div>

    <div class="split">
      <!-- LEFT: Controls -->
      <div class="card">
        <div class="split">
          <div>
            <label>Team A</label>
            <input id="teamAName" />
          </div>
          <div>
            <label>Team B</label>
            <input id="teamBName" />
          </div>
        </div>

        <div class="dangerLine"></div>

        <div class="split">
          <!-- Team A panel -->
          <div class="teamPanel">
            <div class="row" style="justify-content:space-between;align-items:flex-end">
              <div>
                <div class="teamName" id="teamALabel">Team A</div>
                <div class="bigLabel">Score</div>
              </div>
              <div class="bigNum" id="scoreA">0</div>
            </div>
            <div class="btnGrid3" style="margin-top:10px">
              <button class="good" data-act="A_S+1">+1</button>
              <button class="good" data-act="A_S+2">+2</button>
              <button class="good" data-act="A_S+3">+3</button>
              <button class="bad"  data-act="A_S-1">-1</button>
              <button class="warn" data-act="A_SSET">Set…</button>
              <button class="ghost" data-act="A_S0">Reset</button>
            </div>

            <div class="dangerLine"></div>

            <div class="row" style="justify-content:space-between">
              <div>
                <div class="bigLabel">Team fouls (this quarter)</div>
                <div class="bigNum" style="font-size:34px" id="tfA">0</div>
              </div>
              <div class="btnGrid2" style="min-width:180px">
                <button class="warn" data-act="A_TF+1">+1</button>
                <button class="bad"  data-act="A_TF-1">-1</button>
              </div>
            </div>

            <div class="dangerLine"></div>

            <div class="row" style="justify-content:space-between">
              <div>
                <div class="bigLabel">Timeouts remaining</div>
                <div class="bigNum" style="font-size:34px" id="toA">3</div>
              </div>
              <div class="btnGrid2" style="min-width:180px">
                <button data-act="A_TO-1" class="warn">Use</button>
                <button data-act="A_TO+1" class="ghost">+1</button>
              </div>
            </div>
          </div>

          <!-- Team B panel -->
          <div class="teamPanel">
            <div class="row" style="justify-content:space-between;align-items:flex-end">
              <div>
                <div class="teamName" id="teamBLabel">Team B</div>
                <div class="bigLabel">Score</div>
              </div>
              <div class="bigNum" id="scoreB">0</div>
            </div>
            <div class="btnGrid3" style="margin-top:10px">
              <button class="good" data-act="B_S+1">+1</button>
              <button class="good" data-act="B_S+2">+2</button>
              <button class="good" data-act="B_S+3">+3</button>
              <button class="bad"  data-act="B_S-1">-1</button>
              <button class="warn" data-act="B_SSET">Set…</button>
              <button class="ghost" data-act="B_S0">Reset</button>
            </div>

            <div class="dangerLine"></div>

            <div class="row" style="justify-content:space-between">
              <div>
                <div class="bigLabel">Team fouls (this quarter)</div>
                <div class="bigNum" style="font-size:34px" id="tfB">0</div>
              </div>
              <div class="btnGrid2" style="min-width:180px">
                <button class="warn" data-act="B_TF+1">+1</button>
                <button class="bad"  data-act="B_TF-1">-1</button>
              </div>
            </div>

            <div class="dangerLine"></div>

            <div class="row" style="justify-content:space-between">
              <div>
                <div class="bigLabel">Timeouts remaining</div>
                <div class="bigNum" style="font-size:34px" id="toB">3</div>
              </div>
              <div class="btnGrid2" style="min-width:180px">
                <button data-act="B_TO-1" class="warn">Use</button>
                <button data-act="B_TO+1" class="ghost">+1</button>
              </div>
            </div>
          </div>
        </div>

        <div class="dangerLine"></div>

        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button class="ghost" id="qDownBtn">← Quarter</button>
            <button class="ghost" id="qUpBtn">Quarter →</button>
            <span class="tiny">Team fouls reset on quarter change.</span>
          </div>
        </div>

        <div class="dangerLine"></div>

        <div style="font-weight:900">Personal fouls</div>
        <div class="tiny">Pick team → player → +PF.</div>

        <div class="split" style="margin-top:10px">
          <div>
            <label>Team</label>
            <select id="pfTeam">
              <option value="A">Team A</option>
              <option value="B">Team B</option>
            </select>
          </div>
          <div>
            <label>Player</label>
            <select id="pfPlayer"></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <input id="addPlayerInput" placeholder="Add player (e.g., #12 Jay)"/>
          <button class="primary" id="addPlayerBtn">Add</button>
        </div>

        <div class="btnGrid4" style="margin-top:10px">
          <button class="warn" id="pfPlusBtn">+ PF</button>
          <button class="bad" id="pfMinusBtn">- PF</button>
          <button class="ghost" id="clearRosterBtn">Clear roster (team)</button>
          <button class="ghost" id="quickNoteBtn">Quick note</button>
        </div>

        <div class="dangerLine"></div>

        <label>Supervisor notes</label>
        <textarea id="notes"></textarea>
      </div>

      <!-- RIGHT: log + foul table -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <div class="pill"><span id="sumAName">Team A</span> <b id="sumAScore">0</b></div>
            <div class="pill"><span id="sumBName">Team B</span> <b id="sumBScore">0</b></div>
            <div class="pill"><span>TF</span> <b id="sumTF">0-0</b></div>
            <div class="pill"><span>TO</span> <b id="sumTO">3-3</b></div>
          </div>
        </div>

        <div class="dangerLine"></div>

        <div style="font-weight:900;margin-bottom:8px">Event log</div>
        <div class="log" id="eventLog"></div>

        <div class="dangerLine"></div>

        <div style="font-weight:900;margin-bottom:8px">Player fouls</div>
        <div style="overflow:auto;border:1px solid var(--line);border-radius:12px">
          <table id="pfTable"></table>
        </div>
      </div>
    </div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
    onSnapshot, query, where, orderBy, serverTimestamp, runTransaction, limit
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // IMPORTANT:
  // Replace the object below with your Firebase Web App config.
  // It MUST be a real JS object (not a string, not a placeholder).
  const firebaseConfig = {
    apiKey: "AIzaSyC1wGHvf429a3NnQosIvhzhI_NbV5t7ulc",
    authDomain: "im-basketball-stats.firebaseapp.com",
    projectId: "im-basketball-stats",
    storageBucket: "im-basketball-stats.firebasestorage.app",
    messagingSenderId: "492772621588",
    appId: "1:492772621588:web:f28d79204186a7fb6b9601",
    measurementId: "G-XQERRVTBNT"
  };

  // If you forget to paste config, fail loudly:
  if (!firebaseConfig.projectId) {
    alert("Firebase config missing. Paste your firebaseConfig object into index.html (firebaseConfig.projectId is empty).");
  }

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const el = (id) => document.getElementById(id);
  const connLabel = el("connLabel");

  const viewLobby = el("viewLobby");
  const viewGame = el("viewGame");
  const navLobbyBtn = el("navLobbyBtn");

  const courtSelect = el("courtSelect");
  const startQuarter = el("startQuarter");
  const newTeamA = el("newTeamA");
  const newTeamB = el("newTeamB");
  const createGameBtn = el("createGameBtn");
  const courtsGrid = el("courtsGrid");
  const ongoingList = el("ongoingList");

  const gameCourt = el("gameCourt");
  const gameId = el("gameId");
  const gameQuarter = el("gameQuarter");
  const teamAName = el("teamAName");
  const teamBName = el("teamBName");

  const teamALabel = el("teamALabel");
  const teamBLabel = el("teamBLabel");

  const scoreA = el("scoreA");
  const scoreB = el("scoreB");
  const tfA = el("tfA");
  const tfB = el("tfB");
  const toA = el("toA");
  const toB = el("toB");

  const qUpBtn = el("qUpBtn");
  const qDownBtn = el("qDownBtn");
  const endGameBtn = el("endGameBtn");
  const undoBtn = el("undoBtn");

  const pfTeam = el("pfTeam");
  const pfPlayer = el("pfPlayer");
  const addPlayerInput = el("addPlayerInput");
  const addPlayerBtn = el("addPlayerBtn");
  const pfPlusBtn = el("pfPlusBtn");
  const pfMinusBtn = el("pfMinusBtn");
  const clearRosterBtn = el("clearRosterBtn");

  const notes = el("notes");
  const quickNoteBtn = el("quickNoteBtn");

  const eventLog = el("eventLog");
  const pfTable = el("pfTable");

  const sumAName = el("sumAName");
  const sumBName = el("sumBName");
  const sumAScore = el("sumAScore");
  const sumBScore = el("sumBScore");
  const sumTF = el("sumTF");
  const sumTO = el("sumTO");

  // State
  let currentGameId = null;
  let unsubGame = null;
  let unsubEvents = null;
  let unsubPlayersA = null;
  let unsubPlayersB = null;

  // Lobby subscription stays always on (fine for 6 courts)
  let unsubLobby = null;

  const clamp0 = (n) => {
    const x = Number(n);
    if (!Number.isFinite(x)) return 0;
    return Math.max(0, Math.trunc(x));
  };
  const escapeHtml = (s) => String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

  const gameRef = (id) => doc(db, "games", id);
  const eventsCol = (id) => collection(db, "games", id, "events");
  const playersCol = (id, team) => collection(db, "games", id, "players_" + team); // players_A / players_B

  function newGameDoc({court, q, teamA, teamB}){
    return {
      status: "live",
      court,
      quarter: q,
      teamAName: teamA || "Team A",
      teamBName: teamB || "Team B",
      scoreA: 0,
      scoreB: 0,
      teamFoulsA: 0,
      teamFoulsB: 0,
      timeoutsA: 3,
      timeoutsB: 3,
      notes: "",
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };
  }

  async function addEvent(gameId, type, payload){
    await addDoc(eventsCol(gameId), {
      ts: serverTimestamp(),
      type,
      ...payload
    });
  }

  // --------- FIXED: Create game shows errors + disables button
  async function createGame(){
    try {
      createGameBtn.disabled = true;
      createGameBtn.textContent = "Creating...";

      const court = clamp0(courtSelect.value);
      const q = clamp0(startQuarter.value);
      const teamA = newTeamA.value.trim();
      const teamB = newTeamB.value.trim();

      if (!court || court < 1 || court > 6) throw new Error("Pick a court (1–6).");
      if (!q || q < 1 || q > 4) throw new Error("Pick a quarter (1–4).");

      const ref = await addDoc(collection(db, "games"), newGameDoc({court, q, teamA, teamB}));
      await addEvent(ref.id, "GAME_CREATE", { label: `Game created on Court ${court} (Q${q})` });

      location.hash = "#game=" + ref.id;
    } catch (err) {
      console.error(err);
      alert("Create game failed:\n" + (err?.message || String(err)));
      connLabel.textContent = "ERROR";
    } finally {
      createGameBtn.disabled = false;
      createGameBtn.textContent = "Create game";
    }
  }

  // Lobby rendering
  function renderCourts(games){
    const byCourt = new Map();
    for (const g of games) byCourt.set(g.court, g);

    const cards = [];
    for (let c=1;c<=6;c++){
      const g = byCourt.get(c);
      if (!g){
        cards.push(`
          <div class="courtCard">
            <div class="courtTop">
              <div class="courtNum">Court ${c}</div>
              <div class="statusIdle">Idle</div>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="primary" data-startcourt="${c}">Start</button>
            </div>
          </div>
        `);
      } else {
        cards.push(`
          <div class="courtCard">
            <div class="courtTop">
              <div class="courtNum">Court ${c}</div>
              <div class="statusLive">LIVE • Q${g.quarter}</div>
            </div>
            <div style="margin-top:10px">
              <div><b>${escapeHtml(g.teamAName)}</b> ${g.scoreA} • TF ${g.teamFoulsA} • TO ${g.timeoutsA}</div>
              <div><b>${escapeHtml(g.teamBName)}</b> ${g.scoreB} • TF ${g.teamFoulsB} • TO ${g.timeoutsB}</div>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="primary" data-opengame="${g.id}">Open</button>
            </div>
          </div>
        `);
      }
    }
    courtsGrid.innerHTML = cards.join("");

    courtsGrid.querySelectorAll("[data-startcourt]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        courtSelect.value = btn.dataset.startcourt;
        newTeamA.focus();
        window.scrollTo({top:0, behavior:"smooth"});
      });
    });

    courtsGrid.querySelectorAll("[data-opengame]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        location.hash = "#game=" + btn.dataset.opengame;
      });
    });
  }

  function renderOngoingList(games){
    if (!games.length){
      ongoingList.innerHTML = `<div class="tiny">No live games.</div>`;
      return;
    }
    ongoingList.innerHTML = games
      .slice()
      .sort((a,b)=> (a.court-b.court))
      .map(g=> `
        <div class="row" style="justify-content:space-between;border-bottom:1px solid var(--line);padding:8px 0">
          <div>
            <b>Court ${g.court}</b> • Q${g.quarter}<br>
            <span class="tiny">${escapeHtml(g.teamAName)} ${g.scoreA} vs ${escapeHtml(g.teamBName)} ${g.scoreB}</span>
          </div>
          <button class="primary" data-opengame="${g.id}">Open</button>
        </div>
      `).join("");

    ongoingList.querySelectorAll("[data-opengame]").forEach(btn=>{
      btn.addEventListener("click", ()=> location.hash = "#game=" + btn.dataset.opengame);
    });
  }

  function subscribeLobby(){
    const qy = query(collection(db, "games"), where("status","==","live"), orderBy("court","asc"));
    return onSnapshot(qy, (snap)=>{
      const games = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderCourts(games);
      renderOngoingList(games);
      connLabel.textContent = "LIVE";
    }, (err)=>{
      console.error(err);
      connLabel.textContent = "ERROR";
    });
  }

  // Game view subscriptions
  function teardownGameSubs(){
    if (unsubGame) unsubGame();
    if (unsubEvents) unsubEvents();
    if (unsubPlayersA) unsubPlayersA();
    if (unsubPlayersB) unsubPlayersB();
    unsubGame = unsubEvents = unsubPlayersA = unsubPlayersB = null;
  }

  function showLobby(){
    teardownGameSubs();
    currentGameId = null;
    viewGame.style.display = "none";
    viewLobby.style.display = "block";
    navLobbyBtn.style.display = "none";
    el("hdrTitle").textContent = "IM Supervisor Console";
    el("hdrSub").textContent = "";
  }

  async function openGame(id){
    teardownGameSubs();
    currentGameId = id;
    viewLobby.style.display = "none";
    viewGame.style.display = "block";
    navLobbyBtn.style.display = "inline-flex";
    el("hdrTitle").textContent = "Game Console";
    el("hdrSub").textContent = "";

    unsubGame = onSnapshot(gameRef(id), (snap)=>{
      if (!snap.exists()){
        alert("Game not found.");
        location.hash = "#";
        return;
      }
      const g = snap.data();
      renderGameDoc(id, g);
      connLabel.textContent = "LIVE";
    }, (err)=>{
      console.error(err);
      connLabel.textContent = "ERROR";
    });

    const eq = query(eventsCol(id), orderBy("ts","desc"), limit(80));
    unsubEvents = onSnapshot(eq, (snap)=>{
      const ev = snap.docs.map(d => ({id: d.id, ...d.data()}));
      renderEvents(ev);
    });

    unsubPlayersA = onSnapshot(query(playersCol(id,"A"), orderBy("name","asc")), (snap)=>{
      const players = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderPlayers("A", players);
    });
    unsubPlayersB = onSnapshot(query(playersCol(id,"B"), orderBy("name","asc")), (snap)=>{
      const players = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderPlayers("B", players);
    });
  }

  function renderGameDoc(id, g){
    gameId.textContent = id.slice(0,8).toUpperCase();
    gameCourt.textContent = "Court " + g.court;
    gameQuarter.textContent = "Q" + g.quarter;

    // avoid cursor-jumping: only set if different
    if (teamAName.value !== g.teamAName) teamAName.value = g.teamAName;
    if (teamBName.value !== g.teamBName) teamBName.value = g.teamBName;

    teamALabel.textContent = g.teamAName;
    teamBLabel.textContent = g.teamBName;

    scoreA.textContent = g.scoreA;
    scoreB.textContent = g.scoreB;
    tfA.textContent = g.teamFoulsA;
    tfB.textContent = g.teamFoulsB;
    toA.textContent = g.timeoutsA;
    toB.textContent = g.timeoutsB;

    sumAName.textContent = g.teamAName;
    sumBName.textContent = g.teamBName;
    sumAScore.textContent = g.scoreA;
    sumBScore.textContent = g.scoreB;
    sumTF.textContent = `${g.teamFoulsA}-${g.teamFoulsB}`;
    sumTO.textContent = `${g.timeoutsA}-${g.timeoutsB}`;

    if (notes.value !== (g.notes ?? "")) notes.value = g.notes ?? "";
  }

  async function mutateGame(mutator, eventType, eventPayload){
    const id = currentGameId;
    if (!id) return;
    await runTransaction(db, async (tx)=>{
      const ref = gameRef(id);
      const snap = await tx.get(ref);
      if (!snap.exists()) throw new Error("Missing game");
      const g = snap.data();
      const updated = mutator(structuredClone(g));
      updated.updatedAt = serverTimestamp();
      tx.update(ref, updated);
    });
    await addEvent(id, eventType, eventPayload);
  }

  // Rules:
  // - Team fouls reset each quarter
  // - Halftime (moving into Q3): remaining timeouts capped to 2
  async function setQuarter(newQ){
    newQ = clamp0(newQ);
    if (newQ < 1 || newQ > 4) return;

    await mutateGame((g)=>{
      const oldQ = g.quarter;

      g.quarter = newQ;

      if (newQ !== oldQ){
        g.teamFoulsA = 0;
        g.teamFoulsB = 0;
      }

      if (oldQ <= 2 && newQ >= 3){
        g.timeoutsA = Math.min(g.timeoutsA, 2);
        g.timeoutsB = Math.min(g.timeoutsB, 2);
      }
      return g;
    }, "QUARTER_SET", { label: `Quarter set to Q${newQ}` });
  }

  async function adjust(path, delta, label){
    await mutateGame((g)=>{
      g[path] = clamp0((g[path] ?? 0) + delta);
      return g;
    }, "ADJUST", { label, delta, path });
  }

  async function setValue(path, value, label){
    value = clamp0(value);
    await mutateGame((g)=>{
      g[path] = value;
      return g;
    }, "SET", { label, value, path });
  }

  // Undo: supports ADJUST and PF. (SET undo intentionally blocked.)
  async function undoLastSafe(){
    const id = currentGameId;
    if (!id) return;

    const latestQ = query(eventsCol(id), orderBy("ts","desc"), limit(1));
    const stop = onSnapshot(latestQ, (snap)=>{
      stop();
      (async ()=>{
        if (snap.empty) return;
        const latestDoc = snap.docs[0];
        const e = latestDoc.data();

        if (e.type === "ADJUST" && typeof e.delta === "number" && typeof e.path === "string"){
          await mutateGame((g)=>{
            g[e.path] = clamp0((g[e.path] ?? 0) - e.delta);
            return g;
          }, "UNDO", { label: `Undo: ${e.label}` });
          await deleteDoc(latestDoc.ref);
          return;
        }

        if (e.type === "SET"){
          alert("Undo for 'Set…' actions is disabled. Use +/- instead.");
          return;
        }

        if (e.type === "PF" && e.team && e.playerId && typeof e.delta === "number"){
          const pref = doc(db, "games", id, "players_" + e.team, e.playerId);
          await runTransaction(db, async (tx)=>{
            const ps = await tx.get(pref);
            if (!ps.exists()) return;
            const p = ps.data();
            tx.update(pref, { pf: clamp0((p.pf ?? 0) - e.delta) });
          });
          await addEvent(id, "UNDO", { label: `Undo PF` });
          await deleteDoc(latestDoc.ref);
          return;
        }

        alert("Undo not supported for that action.");
      })().catch(console.error);
    });
  }

  // Players
  let playersCacheA = [];
  let playersCacheB = [];

  function renderPlayers(team, players){
    if (team === "A") playersCacheA = players;
    if (team === "B") playersCacheB = players;
    refreshPfDropdown();
    renderPfTable();
  }

  function refreshPfDropdown(){
    const team = pfTeam.value;
    const list = team === "A" ? playersCacheA : playersCacheB;
    pfPlayer.innerHTML = list.map(p => `<option value="${p.id}">${escapeHtml(p.name)} (PF ${p.pf ?? 0})</option>`).join("");
  }

  function renderPfTable(){
    const rows = [];
    const add = (team, list) => {
      const tn = team === "A" ? (teamAName.value || "Team A") : (teamBName.value || "Team B");
      const sorted = list.slice().sort((a,b)=> (b.pf??0)-(a.pf??0) || (a.name||"").localeCompare(b.name||""));
      for (const p of sorted){
        rows.push([tn, p.name, String(p.pf ?? 0)]);
      }
    };
    add("A", playersCacheA);
    add("B", playersCacheB);

    pfTable.innerHTML = `
      <thead><tr><th>Team</th><th>Player</th><th style="text-align:right">PF</th></tr></thead>
      <tbody>
        ${rows.length ? rows.map(r=>`
          <tr>
            <td>${escapeHtml(r[0])}</td>
            <td>${escapeHtml(r[1])}</td>
            <td style="text-align:right"><b>${escapeHtml(r[2])}</b></td>
          </tr>
        `).join("") : `<tr><td colspan="3" class="tiny">Add players to track personal fouls.</td></tr>`}
      </tbody>
    `;
  }

  async function addPlayer(team, name){
    name = name.trim();
    if (!name) return;
    const id = currentGameId;
    if (!id) return;
    await addDoc(playersCol(id, team), { name, pf: 0 });
    await addEvent(id, "ROSTER", { label: `Add player (${team}): ${name}` });
  }

  async function clearRoster(team){
    const id = currentGameId;
    if (!id) return;
    if (!confirm(`Clear roster for Team ${team}?`)) return;

    const list = team === "A" ? playersCacheA : playersCacheB;
    for (const p of list){
      await deleteDoc(doc(db, "games", id, "players_" + team, p.id));
    }
    await addEvent(id, "ROSTER", { label: `Clear roster Team ${team}` });
  }

  async function adjustPF(delta){
    const id = currentGameId;
    if (!id) return;
    const team = pfTeam.value;
    const pid = pfPlayer.value;
    if (!pid) return alert("Select/add a player first.");

    const pref = doc(db, "games", id, "players_" + team, pid);
    await runTransaction(db, async (tx)=>{
      const ps = await tx.get(pref);
      if (!ps.exists()) throw new Error("Missing player");
      const p = ps.data();
      tx.update(pref, { pf: clamp0((p.pf ?? 0) + delta) });
    });
    await addEvent(id, "PF", { team, playerId: pid, delta, label: `PF ${delta > 0 ? "+" : ""}${delta}` });
  }

  // Events rendering
  function renderEvents(events){
    if (!events.length){
      eventLog.innerHTML = `<div class="logItem"><div class="tiny">No events yet.</div></div>`;
      return;
    }
    eventLog.innerHTML = events.map(e=>{
      const tagClass =
        e.type === "ADJUST" ? "warn" :
        e.type === "PF" ? "bad" :
        e.type === "QUARTER_SET" ? "warn" :
        e.type === "GAME_CREATE" ? "good" :
        e.type === "UNDO" ? "warn" : "";
      return `
        <div class="logItem">
          <div class="row" style="gap:8px">
            <span class="tag ${tagClass}">${escapeHtml(e.type)}</span>
            <span class="tiny">${escapeHtml(e.label ?? "")}</span>
          </div>
          <div class="tiny">${e.ts?.toDate ? e.ts.toDate().toLocaleTimeString() : ""}</div>
        </div>
      `;
    }).join("");
  }

  // ---- Wiring
  createGameBtn.addEventListener("click", createGame);
  el("refreshBtn").addEventListener("click", ()=> location.reload());
  navLobbyBtn.addEventListener("click", ()=> location.hash = "#");

  document.querySelectorAll("[data-act]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const act = btn.dataset.act;
      if (!currentGameId) return;

      const setPrompt = async (team) => {
        const isA = team === "A";
        const path = isA ? "scoreA" : "scoreB";
        const cur = isA ? scoreA.textContent : scoreB.textContent;
        const v = prompt(`Set Team ${team} score to:`, cur);
        if (v == null) return;
        await setValue(path, v, `Score ${team}`);
      };

      // Score
      if (act === "A_SSET") return setPrompt("A");
      if (act === "B_SSET") return setPrompt("B");
      if (act === "A_S0") return setValue("scoreA", 0, "Score A");
      if (act === "B_S0") return setValue("scoreB", 0, "Score B");
      if (act.startsWith("A_S")) return adjust("scoreA", Number(act.slice(3)), `Score A ${act.slice(2)}`);
      if (act.startsWith("B_S")) return adjust("scoreB", Number(act.slice(3)), `Score B ${act.slice(2)}`);

      // Team fouls
      if (act.startsWith("A_TF")) return adjust("teamFoulsA", Number(act.slice(4)), `Team Fouls A ${act.slice(3)}`);
      if (act.startsWith("B_TF")) return adjust("teamFoulsB", Number(act.slice(4)), `Team Fouls B ${act.slice(3)}`);

      // Timeouts remaining (use = -1)
      if (act.startsWith("A_TO")) return adjust("timeoutsA", Number(act.slice(4)), `Timeouts A ${act.slice(3)}`);
      if (act.startsWith("B_TO")) return adjust("timeoutsB", Number(act.slice(4)), `Timeouts B ${act.slice(3)}`);
    });
  });

  qUpBtn.addEventListener("click", async ()=>{
    const q = clamp0(gameQuarter.textContent.replace("Q",""));
    await setQuarter(Math.min(4, q + 1));
  });
  qDownBtn.addEventListener("click", async ()=>{
    const q = clamp0(gameQuarter.textContent.replace("Q",""));
    await setQuarter(Math.max(1, q - 1));
  });

  teamAName.addEventListener("input", async ()=>{
    if (!currentGameId) return;
    await updateDoc(gameRef(currentGameId), { teamAName: teamAName.value || "Team A", updatedAt: serverTimestamp() });
  });
  teamBName.addEventListener("input", async ()=>{
    if (!currentGameId) return;
    await updateDoc(gameRef(currentGameId), { teamBName: teamBName.value || "Team B", updatedAt: serverTimestamp() });
  });

  let notesTimer = null;
  notes.addEventListener("input", ()=>{
    if (!currentGameId) return;
    clearTimeout(notesTimer);
    notesTimer = setTimeout(async ()=>{
      await updateDoc(gameRef(currentGameId), { notes: notes.value || "", updatedAt: serverTimestamp() });
      await addEvent(currentGameId, "NOTE", { label: "Notes updated" });
    }, 600);
  });

  pfTeam.addEventListener("change", refreshPfDropdown);
  addPlayerBtn.addEventListener("click", async ()=>{
    await addPlayer(pfTeam.value, addPlayerInput.value);
    addPlayerInput.value = "";
  });
  addPlayerInput.addEventListener("keydown", (e)=>{ if (e.key === "Enter") addPlayerBtn.click(); });
  pfPlusBtn.addEventListener("click", ()=> adjustPF(+1));
  pfMinusBtn.addEventListener("click", ()=> adjustPF(-1));
  clearRosterBtn.addEventListener("click", ()=> clearRoster(pfTeam.value));

  quickNoteBtn.addEventListener("click", async ()=>{
    const t = prompt("Quick note:");
    if (t == null) return;
    const stamp = `[${new Date().toLocaleTimeString()} ${gameQuarter.textContent}] ${t}`;
    notes.value = (notes.value ? notes.value + "\n" : "") + stamp;
    await updateDoc(gameRef(currentGameId), { notes: notes.value, updatedAt: serverTimestamp() });
    await addEvent(currentGameId, "NOTE", { label: "Quick note added" });
  });

  endGameBtn.addEventListener("click", async ()=>{
    if (!currentGameId) return;
    if (!confirm("End game?")) return;
    await updateDoc(gameRef(currentGameId), { status: "final", updatedAt: serverTimestamp() });
    await addEvent(currentGameId, "GAME_END", { label: "Game ended" });
    location.hash = "#";
  });

  undoBtn.addEventListener("click", undoLastSafe);

  // Routing
  function route(){
    const h = location.hash || "#";
    if (h.startsWith("#game=")){
      const id = h.split("=").slice(1).join("=");
      openGame(id);
    } else {
      showLobby();
    }
  }
  window.addEventListener("hashchange", route);

  // Start lobby
  unsubLobby = subscribeLobby();
  connLabel.textContent = "LIVE";
  route();
</script>
</body>
</html>