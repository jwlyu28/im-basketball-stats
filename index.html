<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IM Basketball Supervisor Console</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a27; --muted:#8aa0b8; --text:#e9f0f7;
      --line:#243246; --accent:#4da3ff; --good:#37d67a; --bad:#ff5c5c;
      --warn:#ffd166;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{
      padding:14px 16px;border-bottom:1px solid var(--line);
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap
    }
    header h1{margin:0;font-size:16px;letter-spacing:.3px}
    header .sub{color:var(--muted);font-size:12px}
    main{padding:14px;max-width:1200px;margin:0 auto;display:grid;gap:12px}
    .grid{display:grid;gap:12px;grid-template-columns: 420px 1fr}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .split{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width: 560px){ .split{grid-template-columns:1fr} }
    label{font-size:12px;color:var(--muted)}
    input, select, textarea, button{
      background:#0e1522;border:1px solid var(--line);color:var(--text);
      padding:10px 10px;border-radius:12px;font-size:14px
    }
    input, select{width:100%}
    textarea{width:100%;min-height:96px;resize:vertical}
    button{cursor:pointer;user-select:none}
    button.primary{border-color:transparent;background:var(--accent);color:#06101c;font-weight:800}
    button.good{border-color:transparent;background:var(--good);color:#06101c;font-weight:900}
    button.bad{border-color:transparent;background:var(--bad);color:#2b0505;font-weight:900}
    button.warn{border-color:transparent;background:var(--warn);color:#2b2205;font-weight:900}
    button.ghost{background:transparent}
    .tiny{font-size:12px;color:var(--muted)}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);padding:8px 10px;border-radius:999px}
    .dangerLine{border-top:1px dashed var(--line);margin:10px 0}
    .bigNum{font-size:48px;font-weight:900;letter-spacing:1px;line-height:1}
    .bigLabel{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
    .teamHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .teamName{font-size:16px;font-weight:800}
    .btnGrid{display:grid;gap:10px;grid-template-columns:repeat(3, minmax(0,1fr))}
    .btnGrid2{display:grid;gap:10px;grid-template-columns:repeat(2, minmax(0,1fr))}
    .btnGrid4{display:grid;gap:10px;grid-template-columns:repeat(4, minmax(0,1fr))}
    @media (max-width: 560px){
      .btnGrid4{grid-template-columns:repeat(2, minmax(0,1fr))}
    }
    .mini{padding:8px 10px;font-size:13px;border-radius:10px}
    .log{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:12px}
    .logItem{
      display:flex;justify-content:space-between;gap:10px;
      padding:10px;border-bottom:1px solid var(--line)
    }
    .logItem:last-child{border-bottom:none}
    .logLeft{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tag{font-size:12px;border:1px solid var(--line);padding:4px 8px;border-radius:999px;color:var(--muted)}
    .tag.good{background:rgba(55,214,122,.14);border-color:rgba(55,214,122,.35);color:#bff2d2}
    .tag.bad{background:rgba(255,92,92,.12);border-color:rgba(255,92,92,.35);color:#ffd0d0}
    .tag.warn{background:rgba(255,209,102,.12);border-color:rgba(255,209,102,.35);color:#ffefc4}
    table{width:100%;border-collapse:collapse}
    th, td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:700}
    td:last-child, th:last-child{text-align:right}
    .stickyActions{
      position:sticky;bottom:0;background:linear-gradient(to top, rgba(18,26,39,1), rgba(18,26,39,.85));
      padding-top:10px;margin-top:10px
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>IM Basketball Supervisor Console</h1>
    <div class="sub">Score • Team fouls • Player fouls • Timeouts • Notes • Undo</div>
  </div>
  <div class="row">
    <div class="pill"><span>Game</span> <b id="gameIdLabel"></b></div>
    <div class="pill"><span>Period</span> <b id="periodLabel">1</b></div>
    <button class="ghost" id="newGameBtn">New game</button>
    <button class="primary" id="exportBtn">Export CSV</button>
  </div>
</header>

<main>
  <div class="grid">

    <!-- LEFT: "Console" -->
    <section class="card">
      <div class="split">
        <div>
          <label>Team A name</label>
          <input id="teamAName" placeholder="Team A" />
        </div>
        <div>
          <label>Team B name</label>
          <input id="teamBName" placeholder="Team B" />
        </div>
      </div>

      <div class="dangerLine"></div>

      <div class="split">
        <!-- TEAM A PANEL -->
        <div class="card" style="padding:12px">
          <div class="teamHeader">
            <div>
              <div class="teamName" id="teamALabel">Team A</div>
              <div class="bigLabel">Score</div>
            </div>
            <div class="bigNum" id="scoreALabel">0</div>
          </div>

          <div class="btnGrid" style="margin-top:10px">
            <button class="good" data-act="A_SCORE_1">+1</button>
            <button class="good" data-act="A_SCORE_2">+2</button>
            <button class="good" data-act="A_SCORE_3">+3</button>
            <button class="bad"  data-act="A_SCORE_-1">-1</button>
            <button class="ghost" data-act="A_SCORE_RESET">Reset</button>
            <button class="warn" data-act="A_SCORE_SET">Set…</button>
          </div>

          <div class="dangerLine"></div>

          <div class="row" style="justify-content:space-between">
            <div>
              <div class="bigLabel">Team fouls</div>
              <div class="bigNum" style="font-size:34px" id="teamFoulsALabel">0</div>
            </div>
            <div class="btnGrid2" style="min-width:190px">
              <button class="warn" data-act="A_TEAMFOUL_+1">+1</button>
              <button class="bad"  data-act="A_TEAMFOUL_-1">-1</button>
            </div>
          </div>

          <div class="dangerLine"></div>

          <div class="row" style="justify-content:space-between">
            <div>
              <div class="bigLabel">Timeouts</div>
              <div class="bigNum" style="font-size:34px" id="timeoutsALabel">0</div>
            </div>
            <div class="btnGrid2" style="min-width:190px">
              <button data-act="A_TO_+1">+1</button>
              <button class="bad" data-act="A_TO_-1">-1</button>
            </div>
          </div>
        </div>

        <!-- TEAM B PANEL -->
        <div class="card" style="padding:12px">
          <div class="teamHeader">
            <div>
              <div class="teamName" id="teamBLabel">Team B</div>
              <div class="bigLabel">Score</div>
            </div>
            <div class="bigNum" id="scoreBLabel">0</div>
          </div>

          <div class="btnGrid" style="margin-top:10px">
            <button class="good" data-act="B_SCORE_1">+1</button>
            <button class="good" data-act="B_SCORE_2">+2</button>
            <button class="good" data-act="B_SCORE_3">+3</button>
            <button class="bad"  data-act="B_SCORE_-1">-1</button>
            <button class="ghost" data-act="B_SCORE_RESET">Reset</button>
            <button class="warn" data-act="B_SCORE_SET">Set…</button>
          </div>

          <div class="dangerLine"></div>

          <div class="row" style="justify-content:space-between">
            <div>
              <div class="bigLabel">Team fouls</div>
              <div class="bigNum" style="font-size:34px" id="teamFoulsBLabel">0</div>
            </div>
            <div class="btnGrid2" style="min-width:190px">
              <button class="warn" data-act="B_TEAMFOUL_+1">+1</button>
              <button class="bad"  data-act="B_TEAMFOUL_-1">-1</button>
            </div>
          </div>

          <div class="dangerLine"></div>

          <div class="row" style="justify-content:space-between">
            <div>
              <div class="bigLabel">Timeouts</div>
              <div class="bigNum" style="font-size:34px" id="timeoutsBLabel">0</div>
            </div>
            <div class="btnGrid2" style="min-width:190px">
              <button data-act="B_TO_+1">+1</button>
              <button class="bad" data-act="B_TO_-1">-1</button>
            </div>
          </div>
        </div>
      </div>

      <div class="dangerLine"></div>

      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button class="ghost" id="periodDown">- Period</button>
          <button class="ghost" id="periodUp">+ Period</button>
          <button class="ghost" id="resetTeamFoulsBtn">Reset team fouls</button>
        </div>
        <div class="row">
          <button class="bad" id="undoBtn">Undo last</button>
        </div>
      </div>

      <div class="dangerLine"></div>

      <!-- PLAYER FOULS -->
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900">Player fouls (required)</div>
          <div class="tiny">Fast entry: select team → pick player → tap “+ PF”.</div>
        </div>
        <div class="row">
          <label class="tiny" style="margin-right:6px">Optional points</label>
          <input id="pointsToggle" type="checkbox" style="width:auto;transform:scale(1.15)" />
        </div>
      </div>

      <div class="split" style="margin-top:10px">
        <div>
          <label>Team</label>
          <select id="teamSelect">
            <option value="A">Team A</option>
            <option value="B">Team B</option>
          </select>
        </div>
        <div>
          <label>Player</label>
          <select id="playerSelect"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="playerNameInput" placeholder="Add player (e.g., #12 Jay / Jay #12)" />
        <button class="primary" id="addPlayerBtn">Add</button>
      </div>

      <div class="btnGrid4" style="margin-top:10px">
        <button class="warn" data-act="PLAYER_PF_+1">+ PF</button>
        <button class="bad"  data-act="PLAYER_PF_-1">- PF</button>
        <button class="ghost" id="clearRosterTeamBtn">Clear team roster</button>
        <button class="ghost" id="quickTechNoteBtn">Tech note</button>
      </div>

      <div id="pointsPanel" style="display:none;margin-top:10px">
        <div class="tiny">Optional: record individual points (keeps it lightweight).</div>
        <div class="btnGrid" style="margin-top:10px">
          <button class="good" data-act="PLAYER_PTS_+1">+1</button>
          <button class="good" data-act="PLAYER_PTS_+2">+2</button>
          <button class="good" data-act="PLAYER_PTS_+3">+3</button>
          <button class="bad"  data-act="PLAYER_PTS_-1">-1</button>
          <button class="bad"  data-act="PLAYER_PTS_-2">-2</button>
          <button class="bad"  data-act="PLAYER_PTS_-3">-3</button>
        </div>
      </div>

      <div class="dangerLine"></div>

      <div>
        <label>Supervisor notes (ref feedback, incidents, scoreboard issues)</label>
        <textarea id="notes" placeholder="Examples:
- White #23 warned for language
- Ref missed goaltend at 6:12 (Period 2)
- Scoreboard console lagging; manual track used"></textarea>
      </div>

    </section>

    <!-- RIGHT: Summary + Log + Player Foul Table -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <div class="pill"><span id="sumAName">Team A</span> <b id="sumAScore">0</b></div>
          <div class="pill"><span id="sumBName">Team B</span> <b id="sumBScore">0</b></div>
          <div class="pill"><span>Team fouls</span> <b id="sumTF">0 - 0</b></div>
          <div class="pill"><span>Timeouts</span> <b id="sumTO">0 - 0</b></div>
        </div>
        <div class="row">
          <button class="ghost" id="resetAllBtn">Reset all counters</button>
        </div>
      </div>

      <div class="dangerLine"></div>

      <div style="font-weight:900;margin-bottom:8px">Event log</div>
      <div class="log" id="log"></div>

      <div class="dangerLine"></div>

      <div style="font-weight:900;margin-bottom:8px">Player foul list</div>
      <div style="overflow:auto;border:1px solid var(--line);border-radius:12px">
        <table id="pfTable"></table>
      </div>

      <div class="stickyActions row" style="justify-content:space-between">
        <div class="tiny">Auto-saves on every tap.</div>
        <div class="row">
          <button class="ghost" id="copySummaryBtn">Copy game summary</button>
        </div>
      </div>
    </section>

  </div>
</main>

<script>
  // ---------- Storage ----------
  const LS_KEY = "im_bball_supervisor_console_v2";
  const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);

  const blankPlayer = (name) => ({
    id: uid(),
    name: name.trim(),
    PF: 0,
    PTS: 0
  });

  const blankGame = () => ({
    gameId: uid().slice(0,8).toUpperCase(),
    createdAt: new Date().toISOString(),
    teamAName: "Team A",
    teamBName: "Team B",
    scoreA: 0,
    scoreB: 0,
    teamFoulsA: 0,
    teamFoulsB: 0,
    timeoutsA: 0,
    timeoutsB: 0,
    period: 1,
    notes: "",
    pointsEnabled: false,
    rosterA: [],
    rosterB: [],
    events: [] // newest at end: {ts, period, type, team, playerId, delta, label}
  });

  let state = load() ?? blankGame();

  function save() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function load() { try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; } }

  // ---------- DOM ----------
  const el = (id) => document.getElementById(id);

  const gameIdLabel = el("gameIdLabel");
  const periodLabel = el("periodLabel");

  const teamAName = el("teamAName");
  const teamBName = el("teamBName");

  const teamALabel = el("teamALabel");
  const teamBLabel = el("teamBLabel");

  const scoreALabel = el("scoreALabel");
  const scoreBLabel = el("scoreBLabel");

  const teamFoulsALabel = el("teamFoulsALabel");
  const teamFoulsBLabel = el("teamFoulsBLabel");

  const timeoutsALabel = el("timeoutsALabel");
  const timeoutsBLabel = el("timeoutsBLabel");

  const teamSelect = el("teamSelect");
  const playerSelect = el("playerSelect");
  const playerNameInput = el("playerNameInput");

  const notes = el("notes");
  const pointsToggle = el("pointsToggle");
  const pointsPanel = el("pointsPanel");

  const sumAName = el("sumAName");
  const sumBName = el("sumBName");
  const sumAScore = el("sumAScore");
  const sumBScore = el("sumBScore");
  const sumTF = el("sumTF");
  const sumTO = el("sumTO");

  const log = el("log");
  const pfTable = el("pfTable");

  // ---------- Helpers ----------
  function roster(team){ return team === "A" ? state.rosterA : state.rosterB; }
  function clamp0(n){ n = Number(n); return Number.isFinite(n) ? Math.max(0, Math.trunc(n)) : 0; }
  function escapeHtml(s){
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }
  function nowISO(){ return new Date().toISOString(); }
  function teamName(team){ return team === "A" ? state.teamAName : state.teamBName; }

  function pushEvent(evt){
    state.events.push(evt);
    // keep it from getting huge
    if (state.events.length > 400) state.events.shift();
  }

  function getSelectedPlayer(){
    const team = teamSelect.value;
    const pid = playerSelect.value;
    const p = roster(team).find(x => x.id === pid);
    return { team, player: p };
  }

  // ---------- Core actions ----------
  function applyDelta(path, delta, meta){
    // path is like "scoreA" or "teamFoulsB"
    state[path] = clamp0(state[path] + delta);
    pushEvent({
      ts: nowISO(),
      period: state.period,
      type: meta.type,
      team: meta.team ?? null,
      playerId: meta.playerId ?? null,
      delta,
      label: meta.label
    });
    save();
    renderAll();
  }

  function setValue(path, newValue, meta){
    const prev = state[path];
    state[path] = clamp0(newValue);
    const delta = state[path] - prev;
    pushEvent({
      ts: nowISO(),
      period: state.period,
      type: meta.type,
      team: meta.team ?? null,
      playerId: meta.playerId ?? null,
      delta,
      label: meta.label + ` (set)`
    });
    save();
    renderAll();
  }

  function undoLast(){
    const last = state.events.pop();
    if (!last) return;

    // Reverse based on type/label. We store deltas so undo is easy for counters.
    // For "set" we only stored delta; reversing delta is correct.
    if (last.label.includes("Score A")) state.scoreA = clamp0(state.scoreA - last.delta);
    else if (last.label.includes("Score B")) state.scoreB = clamp0(state.scoreB - last.delta);
    else if (last.label.includes("Team Fouls A")) state.teamFoulsA = clamp0(state.teamFoulsA - last.delta);
    else if (last.label.includes("Team Fouls B")) state.teamFoulsB = clamp0(state.teamFoulsB - last.delta);
    else if (last.label.includes("Timeouts A")) state.timeoutsA = clamp0(state.timeoutsA - last.delta);
    else if (last.label.includes("Timeouts B")) state.timeoutsB = clamp0(state.timeoutsB - last.delta);
    else if (last.type === "PLAYER_PF" || last.type === "PLAYER_PTS"){
      const r = roster(last.team);
      const p = r.find(x => x.id === last.playerId);
      if (p){
        if (last.type === "PLAYER_PF") p.PF = clamp0(p.PF - last.delta);
        if (last.type === "PLAYER_PTS") p.PTS = clamp0(p.PTS - last.delta);
      }
    } else if (last.type === "NOTE"){
      // we can’t perfectly undo free-text edits; leave it
    }

    save();
    renderAll();
  }

  function resetTeamFouls(){
    setValue("teamFoulsA", 0, {type:"TEAMFOUL_RESET", label:"Team Fouls A"});
    setValue("teamFoulsB", 0, {type:"TEAMFOUL_RESET", label:"Team Fouls B"});
  }

  function resetAllCounters(){
    if (!confirm("Reset score, team fouls, timeouts, and player fouls/points?")) return;
    setValue("scoreA", 0, {type:"RESET", label:"Score A"});
    setValue("scoreB", 0, {type:"RESET", label:"Score B"});
    setValue("teamFoulsA", 0, {type:"RESET", label:"Team Fouls A"});
    setValue("teamFoulsB", 0, {type:"RESET", label:"Team Fouls B"});
    setValue("timeoutsA", 0, {type:"RESET", label:"Timeouts A"});
    setValue("timeoutsB", 0, {type:"RESET", label:"Timeouts B"});
    // player stats
    for (const p of state.rosterA){ p.PF = 0; p.PTS = 0; }
    for (const p of state.rosterB){ p.PF = 0; p.PTS = 0; }
    pushEvent({ts: nowISO(), period: state.period, type:"RESET", team:null, playerId:null, delta:0, label:"Players reset"});
    save();
    renderAll();
  }

  // ---------- Roster ----------
  function refreshPlayerDropdown(){
    const team = teamSelect.value;
    const r = roster(team);
    playerSelect.innerHTML = r.map(p => `<option value="${p.id}">${escapeHtml(p.name)} (PF ${p.PF}${state.pointsEnabled ? `, PTS ${p.PTS}` : ""})</option>`).join("");
  }

  function addPlayer(){
    const name = playerNameInput.value.trim();
    if (!name) return;
    const team = teamSelect.value;
    roster(team).push(blankPlayer(name));
    playerNameInput.value = "";
    pushEvent({ts: nowISO(), period: state.period, type:"ROSTER", team, playerId:null, delta:0, label:`Add player ${name} (${teamName(team)})`});
    save();
    renderAll();
  }

  function clearRosterTeam(){
    const team = teamSelect.value;
    const tName = teamName(team);
    if (!confirm(`Clear roster for ${tName}? (keeps team counters)`)) return;
    if (team === "A") state.rosterA = [];
    else state.rosterB = [];
    pushEvent({ts: nowISO(), period: state.period, type:"ROSTER", team, playerId:null, delta:0, label:`Clear roster (${tName})`});
    save();
    renderAll();
  }

  // ---------- Export / Copy summary ----------
  function exportCSV(){
    const rows = [];
    rows.push(["GameId", state.gameId]);
    rows.push(["CreatedAt", state.createdAt]);
    rows.push(["Period", state.period]);
    rows.push(["TeamA", state.teamAName, "Score", state.scoreA, "TeamFouls", state.teamFoulsA, "Timeouts", state.timeoutsA]);
    rows.push(["TeamB", state.teamBName, "Score", state.scoreB, "TeamFouls", state.teamFoulsB, "Timeouts", state.timeoutsB]);
    rows.push([]);
    rows.push(["Team","Player","PF","PTS"]);
    const add = (teamLabel, r) => {
      for (const p of r) rows.push([teamLabel, p.name, p.PF, state.pointsEnabled ? p.PTS : ""]);
    };
    add(state.teamAName, state.rosterA);
    add(state.teamBName, state.rosterB);
    rows.push([]);
    rows.push(["Notes"]);
    rows.push([state.notes ?? ""]);
    rows.push([]);
    rows.push(["EventLog(ts,period,type,label,team,delta)"]);
    for (const e of state.events){
      rows.push([e.ts, e.period, e.type, e.label, e.team ?? "", e.delta ?? ""]);
    }

    const csv = rows.map(r => r.map(cell => `"${String(cell ?? "").replaceAll('"','""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `IM_Basketball_${state.gameId}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function copySummary(){
    const summary =
`IM Basketball Summary (${state.gameId})
Period: ${state.period}

${state.teamAName}: ${state.scoreA}
Team Fouls: ${state.teamFoulsA}
Timeouts: ${state.timeoutsA}

${state.teamBName}: ${state.scoreB}
Team Fouls: ${state.teamFoulsB}
Timeouts: ${state.timeoutsB}

Notes:
${state.notes || "(none)"}`;
    try{
      await navigator.clipboard.writeText(summary);
      alert("Summary copied.");
    } catch {
      prompt("Copy this:", summary);
    }
  }

  // ---------- UI rendering ----------
  function renderSummary(){
    teamALabel.textContent = state.teamAName;
    teamBLabel.textContent = state.teamBName;

    scoreALabel.textContent = state.scoreA;
    scoreBLabel.textContent = state.scoreB;

    teamFoulsALabel.textContent = state.teamFoulsA;
    teamFoulsBLabel.textContent = state.teamFoulsB;

    timeoutsALabel.textContent = state.timeoutsA;
    timeoutsBLabel.textContent = state.timeoutsB;

    sumAName.textContent = state.teamAName;
    sumBName.textContent = state.teamBName;
    sumAScore.textContent = state.scoreA;
    sumBScore.textContent = state.scoreB;
    sumTF.textContent = `${state.teamFoulsA} - ${state.teamFoulsB}`;
    sumTO.textContent = `${state.timeoutsA} - ${state.timeoutsB}`;

    gameIdLabel.textContent = state.gameId;
    periodLabel.textContent = state.period;

    notes.value = state.notes ?? "";

    pointsToggle.checked = !!state.pointsEnabled;
    pointsPanel.style.display = state.pointsEnabled ? "block" : "none";
  }

  function renderLog(){
    const last = state.events.slice(-120).reverse();
    if (last.length === 0){
      log.innerHTML = `<div class="logItem"><div class="tiny">No events yet. Start tracking.</div></div>`;
      return;
    }
    log.innerHTML = last.map(e => {
      const t = e.team ? teamName(e.team) : "";
      const tagClass =
        e.type === "SCORE" ? "good" :
        e.type === "TEAMFOUL" ? "warn" :
        e.type === "TIMEOUT" ? "warn" :
        e.type === "PLAYER_PF" ? "bad" :
        e.type === "PLAYER_PTS" ? "good" :
        e.type === "RESET" ? "warn" : "";
      const tagText =
        e.type === "SCORE" ? "SCORE" :
        e.type === "TEAMFOUL" ? "TEAM FOUL" :
        e.type === "TIMEOUT" ? "TIMEOUT" :
        e.type === "PLAYER_PF" ? "PF" :
        e.type === "PLAYER_PTS" ? "PTS" :
        e.type;

      const delta = (e.delta === 0 || e.delta == null) ? "" : (e.delta > 0 ? `+${e.delta}` : `${e.delta}`);
      const playerName = (e.playerId && e.team) ? (roster(e.team).find(p => p.id === e.playerId)?.name ?? "") : "";

      return `
        <div class="logItem">
          <div class="logLeft">
            <span class="tag ${tagClass}">${tagText}</span>
            <span class="tiny">P${e.period}</span>
            <span><b>${escapeHtml(e.label)}</b></span>
            ${playerName ? `<span class="tag">${escapeHtml(playerName)}</span>` : ""}
            ${t ? `<span class="tag">${escapeHtml(t)}</span>` : ""}
          </div>
          <div class="tiny">${escapeHtml(delta)}<br>${new Date(e.ts).toLocaleTimeString()}</div>
        </div>
      `;
    }).join("");
  }

  function renderPFTable(){
    const headers = ["Team","Player","PF", state.pointsEnabled ? "PTS" : "", ""].filter(Boolean);
    const rows = [];

    const addRows = (team) => {
      const r = roster(team).slice().sort((a,b) => b.PF - a.PF || a.name.localeCompare(b.name));
      for (const p of r){
        rows.push([
          teamName(team),
          p.name,
          String(p.PF),
          state.pointsEnabled ? String(p.PTS) : null,
          "" // spacer
        ].filter(x => x !== null));
      }
    };
    addRows("A");
    addRows("B");

    pfTable.innerHTML = `
      <thead><tr>${headers.map(h => `<th>${escapeHtml(h)}</th>`).join("")}</tr></thead>
      <tbody>
        ${rows.length ? rows.map(r => `
          <tr>
            <td>${escapeHtml(r[0])}</td>
            <td>${escapeHtml(r[1])}</td>
            <td><b>${escapeHtml(r[2])}</b></td>
            ${state.pointsEnabled ? `<td>${escapeHtml(r[3])}</td>` : ``}
            <td></td>
          </tr>
        `).join("") : `<tr><td colspan="${headers.length}" class="tiny">Add players to start tracking personal fouls.</td></tr>`}
      </tbody>
    `;
  }

  function renderAll(){
    refreshPlayerDropdown();
    renderSummary();
    renderLog();
    renderPFTable();
  }

  // ---------- Action routing ----------
  function handleAction(code){
    // Team scores
    if (code === "A_SCORE_1") return applyDelta("scoreA", +1, {type:"SCORE", team:"A", label:"Score A"});
    if (code === "A_SCORE_2") return applyDelta("scoreA", +2, {type:"SCORE", team:"A", label:"Score A"});
    if (code === "A_SCORE_3") return applyDelta("scoreA", +3, {type:"SCORE", team:"A", label:"Score A"});
    if (code === "A_SCORE_-1") return applyDelta("scoreA", -1, {type:"SCORE", team:"A", label:"Score A"});
    if (code === "A_SCORE_RESET") return setValue("scoreA", 0, {type:"SCORE", team:"A", label:"Score A"});
    if (code === "A_SCORE_SET"){
      const v = prompt("Set Team A score to:", String(state.scoreA));
      if (v == null) return;
      return setValue("scoreA", clamp0(v), {type:"SCORE", team:"A", label:"Score A"});
    }

    if (code === "B_SCORE_1") return applyDelta("scoreB", +1, {type:"SCORE", team:"B", label:"Score B"});
    if (code === "B_SCORE_2") return applyDelta("scoreB", +2, {type:"SCORE", team:"B", label:"Score B"});
    if (code === "B_SCORE_3") return applyDelta("scoreB", +3, {type:"SCORE", team:"B", label:"Score B"});
    if (code === "B_SCORE_-1") return applyDelta("scoreB", -1, {type:"SCORE", team:"B", label:"Score B"});
    if (code === "B_SCORE_RESET") return setValue("scoreB", 0, {type:"SCORE", team:"B", label:"Score B"});
    if (code === "B_SCORE_SET"){
      const v = prompt("Set Team B score to:", String(state.scoreB));
      if (v == null) return;
      return setValue("scoreB", clamp0(v), {type:"SCORE", team:"B", label:"Score B"});
    }

    // Team fouls
    if (code === "A_TEAMFOUL_+1") return applyDelta("teamFoulsA", +1, {type:"TEAMFOUL", team:"A", label:"Team Fouls A"});
    if (code === "A_TEAMFOUL_-1") return applyDelta("teamFoulsA", -1, {type:"TEAMFOUL", team:"A", label:"Team Fouls A"});
    if (code === "B_TEAMFOUL_+1") return applyDelta("teamFoulsB", +1, {type:"TEAMFOUL", team:"B", label:"Team Fouls B"});
    if (code === "B_TEAMFOUL_-1") return applyDelta("teamFoulsB", -1, {type:"TEAMFOUL", team:"B", label:"Team Fouls B"});

    // Timeouts
    if (code === "A_TO_+1") return applyDelta("timeoutsA", +1, {type:"TIMEOUT", team:"A", label:"Timeouts A"});
    if (code === "A_TO_-1") return applyDelta("timeoutsA", -1, {type:"TIMEOUT", team:"A", label:"Timeouts A"});
    if (code === "B_TO_+1") return applyDelta("timeoutsB", +1, {type:"TIMEOUT", team:"B", label:"Timeouts B"});
    if (code === "B_TO_-1") return applyDelta("timeoutsB", -1, {type:"TIMEOUT", team:"B", label:"Timeouts B"});

    // Player PF
    if (code === "PLAYER_PF_+1" || code === "PLAYER_PF_-1"){
      const {team, player} = getSelectedPlayer();
      if (!player) return alert("Add/select a player first.");
      const delta = (code === "PLAYER_PF_+1") ? +1 : -1;
      player.PF = clamp0(player.PF + delta);
      pushEvent({ts: nowISO(), period: state.period, type:"PLAYER_PF", team, playerId: player.id, delta, label:"Personal foul"});
      save();
      renderAll();
      return;
    }

    // Optional points
    if (code.startsWith("PLAYER_PTS_")){
      if (!state.pointsEnabled) return;
      const {team, player} = getSelectedPlayer();
      if (!player) return alert("Add/select a player first.");
      const delta = Number(code.split("_").pop()); // +1, +2, +3, -1...
      player.PTS = clamp0(player.PTS + delta);
      pushEvent({ts: nowISO(), period: state.period, type:"PLAYER_PTS", team, playerId: player.id, delta, label:"Player points"});
      save();
      renderAll();
      return;
    }
  }

  // ---------- Wiring ----------
  document.querySelectorAll("[data-act]").forEach(btn => {
    btn.addEventListener("click", () => handleAction(btn.dataset.act));
  });

  el("addPlayerBtn").addEventListener("click", addPlayer);
  playerNameInput.addEventListener("keydown", (e) => { if (e.key === "Enter") addPlayer(); });

  teamSelect.addEventListener("change", () => { refreshPlayerDropdown(); renderPFTable(); });

  notes.addEventListener("input", () => { state.notes = notes.value; save(); });

  pointsToggle.addEventListener("change", () => {
    state.pointsEnabled = !!pointsToggle.checked;
    pushEvent({ts: nowISO(), period: state.period, type:"SETTING", team:null, playerId:null, delta:0, label:`Points tracking ${state.pointsEnabled ? "ON" : "OFF"}`});
    save();
    renderAll();
  });

  el("undoBtn").addEventListener("click", undoLast);

  el("periodUp").addEventListener("click", () => { state.period = Math.min(20, state.period + 1); save(); renderAll(); });
  el("periodDown").addEventListener("click", () => { state.period = Math.max(1, state.period - 1); save(); renderAll(); });

  el("resetTeamFoulsBtn").addEventListener("click", resetTeamFouls);
  el("resetAllBtn").addEventListener("click", resetAllCounters);

  el("clearRosterTeamBtn").addEventListener("click", clearRosterTeam);

  el("quickTechNoteBtn").addEventListener("click", () => {
    const t = prompt("Quick note (tech / warning / incident):");
    if (t == null) return;
    const stamp = `\n[${new Date().toLocaleTimeString()} P${state.period}] ${t}`;
    state.notes = (state.notes || "") + stamp;
    notes.value = state.notes;
    pushEvent({ts: nowISO(), period: state.period, type:"NOTE", team:null, playerId:null, delta:0, label:`Note added`});
    save();
    renderAll();
  });

  el("copySummaryBtn").addEventListener("click", copySummary);
  el("exportBtn").addEventListener("click", exportCSV);

  el("newGameBtn").addEventListener("click", () => {
    if (!confirm("Start a new game? This replaces your current saved game.")) return;
    state = blankGame();
    save();
    syncUI(true);
  });

  teamAName.addEventListener("input", () => { state.teamAName = teamAName.value || "Team A"; save(); renderAll(); });
  teamBName.addEventListener("input", () => { state.teamBName = teamBName.value || "Team B"; save(); renderAll(); });

  function syncUI(full){
    gameIdLabel.textContent = state.gameId;
    periodLabel.textContent = state.period;

    if (full){
      teamAName.value = state.teamAName;
      teamBName.value = state.teamBName;
      notes.value = state.notes ?? "";
      pointsToggle.checked = !!state.pointsEnabled;
    }
    renderAll();
  }

  // init
  syncUI(true);
</script>
</body>
</html>